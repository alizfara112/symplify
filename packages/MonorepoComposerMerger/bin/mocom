#!/usr/bin/env php
<?php declare(strict_types=1);

use Composer\Json\JsonManipulator;
use Nette\Utils\Json;
use Nette\Utils\Strings;
use Symfony\Component\Finder\Finder;
use Symplify\PackageBuilder\Reflection\PrivatesCaller;

require_once __DIR__ . '/../../../vendor/autoload.php';

$composerPackageFiles = Finder::create()
    ->files()
    ->in(__DIR__ . '/../../../packages')
    ->name('composer.json');

// root compsre.json

$sectionsToMerge = ['require', 'require-dev'];

$collected = [];

$extraItemsPerSection['require-dev'] = [
    'phpstan/phpstan' => '^0.9',
    'tracy/tracy' => '^2.4',
    'slam/php-cs-fixer-extensions' => '^1.15'
];

$removeItemsPerSection['require'] = [
    'phpunit/phpunit', 'tracy/tracy'
];

/** @var \Symfony\Component\Finder\SplFileInfo $packageFile */
foreach ($composerPackageFiles as $packageFile) {
    $packageComposerJsonContent = file_get_contents($packageFile->getRealPath());

    // @todo or use JsonManipulator - https://github.com/composer/composer/blob/3e1b0c88d7397cdd32c4ac151a8175c188ce9318/src/Composer/Json/JsonManipulator.php
    $packageComposerJson = Json::decode($packageComposerJsonContent, Json::FORCE_ARRAY);

    foreach ($sectionsToMerge as $sectionToMerge) {
        if (! isset($packageComposerJson[$sectionToMerge])) {
            continue;
        }

        $collected[$sectionToMerge] = array_merge($collected[$sectionToMerge] ?? [], $packageComposerJson[$sectionToMerge]);
    }
}

$rootComposerJsonContent = file_get_contents(getcwd() . '/composer.json');
$rootComposerJson = Json::decode($rootComposerJsonContent, Json::FORCE_ARRAY);

foreach ($sectionsToMerge as $sectionToMerge) {
    // nothing collected to merge
    if (! isset($collected[$sectionToMerge])) {
        continue;
    }

    // section in root composer.json is empty, just set and go
    if (! isset($rootComposerJson[$sectionToMerge])) {
        $rootComposerJson[$sectionToMerge] = $collected[$sectionToMerge];
        break;
    }

    $collected[$sectionToMerge] = filterOut($collected[$sectionToMerge]);


    if (isset($extraItemsPerSection[$sectionToMerge])) {
        $collected[$sectionToMerge] += $extraItemsPerSection[$sectionToMerge];
    }

    if (isset($removeItemsPerSection[$sectionToMerge])) {
        foreach ($removeItemsPerSection[$sectionToMerge] as $itemToRemove) {
            foreach ($collected[$sectionToMerge] as $item => $value) {
                if ($item === $itemToRemove) {
                    unset($collected[$sectionToMerge][$item]);
                }
            }
        }
    }

    if (isset($rootComposerJson['config']['sort-packages']) && in_array($sectionToMerge, ['require', 'require-dev'])) {
        $collected[$sectionToMerge] = sortPackages($collected[$sectionToMerge]);
    }

    $rootComposerJson[$sectionToMerge] = $collected[$sectionToMerge];
}


file_put_contents('composer.json', Json::encode($rootComposerJson, Json::PRETTY) . PHP_EOL);

function sortPackages(array $packages)
{
    return (new PrivatesCaller)->callPrivateMethodWithReference(JsonManipulator::class, 'sortPackages', $packages);
}

function filterOut(array $packages)
{
    foreach ($packages as $name => $version) {
        if (Strings::startsWith($name, 'symplify')) {
            unset($packages[$name]);
        }
    }

    return $packages;
}
